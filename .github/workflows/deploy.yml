name: deploy

on:
  workflow_call:
    secrets:
      HOST:
        required: true
      USERNAME:
        required: true
      PASSWORD:
        required: true
      SSH_PORT:
        required: true
      DISCORD_WEBHOOK_URL:
        required: true
    inputs:
      environment: # main-api ë˜ëŠ” network-api ì´ì–´ì•¼ í•œë‹¤.
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ë ˆí¬ì§€í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
        uses: actions/checkout@v4

      - name: ë°°í¬í•˜ê¸°
        uses: appleboy/ssh-action@v0.1.7  # SSH
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd /home/whozin/Whoz-in-BE/modules/${{ inputs.environment }}/docker      # í”„ë¡œì íŠ¸ í´ë”ë¡œ ì´ë™
            git fetch origin                                  # branch ì´ë ¥ ê°€ì ¸ì˜¤ê¸°
            git reset --hard origin/develop                    # develop branchë¡œ ì´ë™ 
            ./build-and-deploy.sh                         # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰

      - name: ë””ìŠ¤ì½”ë“œ ì•Œë¦¼ ë³´ë‚´ê¸°
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          BRANCH_NAME: ${{ github.ref_name }}
          WORKFLOW_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          TIMESTAMP: ${{ github.event.repository.updated_at }}
          ENVIRONMENT: ${{ inputs.environment }}
        run: |
          COMMIT_MESSAGE=$(echo "$COMMIT_MESSAGE" | sed ':a;N;$!ba;s/\n/\\n/g')
          
          # JSON Payload ìƒì„±
          DATA=$(cat <<EOF
          {
            "username": "ğŸ””ë°°í¬ ì•Œë¦¬ë¯¸ğŸ””",
            "avatar_url": "https://i.namu.wiki/i/X6s5AIfkjae-h54b7EkMYVg7ityFni1B-YIhtck0g6P914sJTsjykJDEbrsoZdV8rmwmrcyioAH3d2CxLmjxLx20dpHZI1izwMjfs7Dvtuchchyt2HDu7iQyy02_QaU6b8RrxWBt4G0PMQ0IZTykpQ.webp",
            "embeds": [
              {
                "title": "ğŸ‰ğŸ‰ë°°í¬ê°€ ì„±ê³µí–ˆì–´ìš”~!ğŸ‰ğŸ‰",
                "description" : "ë°°í¬ ì•Œë¦¼ì´ ë„ì°©í–ˆì–´ìš”~",
                "type": "rich",
                "color": 123456,
                "author": {
                  "name": "ì¹ ê°€ì´",
                  "icon_url": "https://i.namu.wiki/i/X6s5AIfkjae-h54b7EkMYVg7ityFni1B-YIhtck0g6P914sJTsjykJDEbrsoZdV8rmwmrcyioAH3d2CxLmjxLx20dpHZI1izwMjfs7Dvtuchchyt2HDu7iQyy02_QaU6b8RrxWBt4G0PMQ0IZTykpQ.webp"
                },
                "fields": [
                  {
                    "name": "ì»¤ë°‹ ë©”ì‹œì§€",
                    "value": "\`$COMMIT_MESSAGE\`",
                    "inline": false
                  },
                  {
                    "name": "ë¸Œëœì¹˜",
                    "value": "\`$BRANCH_NAME\`",
                    "inline": false
                  },
                  {
                    "name": "ë°°í¬ í™˜ê²½",
                    "value": "\`$ENVIRONMENT\`",
                    "inline": false
                  },    
                  {
                    "name": "GitHub Actions",
                    "value": "[ë°°í¬ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ í™•ì¸]($WORKFLOW_URL)",
                    "inline": false
                  }
                ]
              }
            ]
          }
          EOF
          )

          # JSON ë°ì´í„° ì¶œë ¥ (ë””ë²„ê¹… ìš©ë„)
          echo "===== JSON PAYLOAD ====="
          echo "$DATA"
          echo "========================"

          # Discord Webhook í˜¸ì¶œ
          curl -X POST -H "Content-Type: application/json" -d "$DATA" "$DISCORD_WEBHOOK_URL"
